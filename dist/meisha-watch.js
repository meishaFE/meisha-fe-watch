!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.MeishaWatch=e():t.MeishaWatch=e()}(window,function(){var o=!!navigator.userAgent.toLowerCase().match(/MicroMessenger/i),n=!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),r=!!navigator.userAgent.match(/Android/i),i=/127.0.0.1|192.168|localhost/.test(window.location.host);function a(t){var e=t.stack.replace(/\n/gi,"").split(/\bat\b/).slice(0,9).join("@").replace(/\?[^:]+/gi,""),o=t.toString();return e.indexOf(o)<0&&(e=o+"@"+e),e}function g(t){var e="";for(var o in t)t.hasOwnProperty(o)&&(e+="&"+o+"="+t[o]);return e.slice(1)}function m(t,e){return("Number"!==e||!Number.isNaN(t))&&toString.call(t).replace(/.*\s(.*)]$/,"$1")===e}function v(t,i){var s=new WeakMap;return function o(e,n){var t,r;return void 0!==i&&(e=i(e)),"object"!=typeof e||null===e||e instanceof Boolean||e instanceof Date||e instanceof Number||e instanceof RegExp||e instanceof String?e:void 0!==(t=s.get(e))?{$ref:t}:(s.set(e,n),Array.isArray(e)?r=e.map(function(t,e){return o(t,n+"["+e+"]")}):(r={},Object.keys(e).forEach(function(t){r[t]=o(e[t],n+"["+t+"]")})),r)}(t,"$")}return new(function(){function t(){this.settings={isReport:!0,reportURL:"",projectId:"",outTime:1e3,partitionId:""},this.__logs=[],this.user="",this.uniqueId="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,o="x"===t?e:3&e|8;return o.toString(16)}),this.timer=null,this.reportTimes=0,n?(Object.defineProperty(this,"logs",{value:[],configurable:!0,enumerable:!0,writable:!0}),Object.defineProperty(this,"logs",{get:function(){return this.__logs},set:function(t){(this.__logs=t).length&&this.checkLogs()}})):this.logs=[],this.agentConsole(),this.agentAJAX(),this.configSender(),this.configListener()}return t.prototype.init=function(t){this.settings=t},t.prototype.agentConsole=function(){var r=this;["log","info","warn","debug","error"].forEach(function(o){var n=console[o];console[o]=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t.length&&"[MeishaWatch Console]"!==t[0]&&(r.logs=r.logs.concat([{msg:t.map(function(t){return"object"==typeof t?JSON.stringify(v(t,void 0)):t}).join(","),url:encodeURIComponent(window.location.href),type:o}])),n.apply(console,t)}})},t.prototype.agentAJAX=function(){var i=this,s=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(){var t=this,e=[].slice.call(arguments),o=e[0],n=e[1],r=t.onreadystatechange||function(){};return t.onreadystatechange=function(){return 4===t.readyState&&400<=t.status&&(i.logs=i.logs.concat([{msg:o+" "+n+" "+t.status,url:encodeURIComponent(window.location.href),type:"error"}])),r.apply(t,arguments)},s.apply(t,e)}},t.prototype.configListener=function(){var s=this;window.onerror=function(t,e,o,n,r){var i=t;r&&r.stack&&(i=a(r)),s.logs=s.logs.concat([{msg:i.substr(0,500),url:encodeURIComponent(window.location.href),type:"error",line:o,col:n}])}},t.prototype.configSender=function(){var t=this;if(n&&window.addEventListener("load",function(){setTimeout(function(){t.report(!0)},1500)},!1),window.addEventListener("unload",function(){t.report(!1)},!1),o&&r){var e="hidden";e in document?document.addEventListener("visibilitychange",function(){document[e]&&t.report(!1)},!1):(e="webkitHidden")in document&&document.addEventListener("webkitvisibilitychange",function(){document[e]&&t.report(!1)},!1)}},t.prototype.setUser=function(t){this.user=t},t.prototype.report=function(t){if(void 0===t&&(t=!0),this.settings){var e=this.settings,o=e.reportURL,n=e.projectId,r=e.partitionId,i=e.isReport,s=void 0===i||i,a=e.outTime;if(s&&this.reportTimes<20&&o&&n&&r){var c=window.performance,u={dns:-1,tcp:-1,ttfb:-1,trans:-1,dom:-1,res:-1,firstbyte:-1,fpt:-1,tti:-1,ready:-1,load:-1};if(c){var p=c.timing;u.dns=p.domainLookupEnd-p.domainLookupStart,u.tcp=p.connectEnd-p.connectStart,u.ttfb=p.responseStart-p.requestStart,u.trans=p.responseEnd-p.responseStart,u.dom=p.domInteractive-p.responseEnd,u.res=p.loadEventStart-p.domContentLoadedEventEnd,u.firstbyte=p.responseStart-p.domainLookupStart,u.fpt=p.responseEnd-p.fetchStart,u.tti=p.domInteractive-p.fetchStart,u.ready=p.domContentLoadedEventEnd-p.fetchStart,u.load=p.loadEventStart-p.fetchStart}var d=m(this.user,"Number")||m(this.user,"String")?this.user:JSON.stringify(this.user),f=JSON.stringify(v(this.logs.slice(),void 0)),l=window.location.host,h=window.location.pathname;this.logs=[];try{!function(t,e,o,n,r,i,s){void 0===n&&(n=!0);var a=!1,c=new XMLHttpRequest,u=setTimeout(function(){a=!0,c.abort()},s);c.onreadystatechange=function(){a||(clearTimeout(u),4===c.readyState&&(200===c.status?r:i)(JSON.parse(c.responseText)))},c.open(e,"GET"===e.toUpperCase()?t+"?"+g(o):t,n),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.send(g(o))}(o,"POST",{projectId:n,partitionId:r,httpHost:l,requestUri:h,logs:f,times:JSON.stringify(u),user:d,uniqueId:this.uniqueId},t,function(){},function(){},a)}catch(t){}finally{this.reportTimes++}}}},t.prototype.useVue=function(){var r=this;return{install:function(t){var e=t.version&&t.version.split(".")||[];2<=+e[0]&&2<=+e[1]&&(t.config.errorHandler=function(t,e,o){i&&console.error("[MeishaWatch Console]",t);var n=t?t.stack?a(t):t:"";o&&(n="[Info: "+o+"]->"+n),e&&e.$options&&e.$options.name&&(n="[Component Name: "+e.$options.name+"]->"+n),r.logs=r.logs.concat([{msg:n,url:encodeURIComponent(window.location.href),type:"error"}])}),function(t){var e=window.location.search.substr(1).match(new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"));return e?decodeURI(e[2]):""}("devtools")&&(t.config.devtools=!0)}}},t.prototype.checkLogs=function(){clearTimeout(this.timer),10<=this.logs.length?this.report():this.timer=setTimeout(this.report,3e3)},t}())});